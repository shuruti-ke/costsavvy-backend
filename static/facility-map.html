<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .map-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .map-controls input[type="checkbox"] {
            accent-color: #0d9488;
            width: 16px;
            height: 16px;
        }
        
        .map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            font-size: 12px;
            color: #555;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        
        .legend-dot.user {
            background: #2563eb;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .legend-dot.facility {
            background: #0d9488;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        /* Custom marker styles */
        .user-marker {
            background: #2563eb;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .facility-marker {
            background: #0d9488;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        
        .price-label {
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            font-weight: bold;
            font-size: 12px;
            color: #0d9488;
            white-space: nowrap;
        }
        
        /* Popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 12px 14px;
            min-width: 200px;
        }
        
        .popup-title {
            color: #0d9488;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .popup-address {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .popup-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        
        .popup-distance {
            font-size: 12px;
            color: #888;
        }
        
        .popup-price {
            font-weight: bold;
            color: #0d9488;
            font-size: 18px;
        }
        
        .popup-network {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #059669;
            margin-top: 6px;
        }
        
        .popup-network svg {
            width: 14px;
            height: 14px;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map"></div>
        
        <div class="map-controls">
            <input type="checkbox" id="searchWhenMoving" checked>
            <label for="searchWhenMoving">Search when moving</label>
        </div>
        
        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-dot user"></div>
                <span>Your location</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot facility"></div>
                <span>Healthcare facilities</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /**
         * FacilityMap - Embedded map showing user location and nearby healthcare facilities
         * 
         * Usage:
         * const map = new FacilityMap('map', mapData);
         * 
         * mapData format:
         * {
         *   user_location: { latitude, longitude, zipcode },
         *   facilities: [{ index, name, latitude, longitude, address, price, distance_miles }],
         *   center: { latitude, longitude },
         *   zoom: 11
         * }
         */
        class FacilityMap {
            constructor(containerId, mapData, options = {}) {
                this.containerId = containerId;
                this.mapData = mapData;
                this.options = {
                    onFacilityClick: options.onFacilityClick || null,
                    showPriceLabels: options.showPriceLabels !== false,
                    ...options
                };
                this.map = null;
                this.markers = [];
                this.priceLabels = [];
                
                this.init();
            }
            
            init() {
                if (!this.mapData?.center) {
                    console.error('Map data with center coordinates required');
                    return;
                }
                
                // Initialize map
                this.map = L.map(this.containerId).setView(
                    [this.mapData.center.latitude, this.mapData.center.longitude],
                    this.mapData.zoom || 11
                );
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(this.map);
                
                this.addMarkers();
                this.fitBounds();
            }
            
            createUserIcon() {
                return L.divIcon({
                    className: 'custom-marker-container',
                    html: '<div class="user-marker"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11],
                });
            }
            
            createFacilityIcon(index) {
                return L.divIcon({
                    className: 'custom-marker-container',
                    html: `<div class="facility-marker">${index}</div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                });
            }
            
            createPriceLabel(price) {
                const priceText = typeof price === 'number' 
                    ? `$${price.toLocaleString()}`
                    : price || '';
                    
                return L.divIcon({
                    className: 'price-label-container',
                    html: `<div class="price-label">${priceText}</div>`,
                    iconSize: [60, 24],
                    iconAnchor: [30, -10],
                });
            }
            
            addMarkers() {
                // Clear existing markers
                this.markers.forEach(m => this.map.removeLayer(m));
                this.priceLabels.forEach(l => this.map.removeLayer(l));
                this.markers = [];
                this.priceLabels = [];
                
                // Add user location marker
                if (this.mapData.user_location?.latitude && this.mapData.user_location?.longitude) {
                    const userMarker = L.marker(
                        [this.mapData.user_location.latitude, this.mapData.user_location.longitude],
                        { icon: this.createUserIcon(), zIndexOffset: 1000 }
                    ).addTo(this.map);
                    
                    userMarker.bindPopup(`
                        <div class="popup-title">Your Location</div>
                        <div class="popup-address">${this.mapData.user_location.zipcode || ''}</div>
                    `);
                    
                    this.markers.push(userMarker);
                }
                
                // Add facility markers
                if (this.mapData.facilities?.length > 0) {
                    this.mapData.facilities.forEach((facility, idx) => {
                        if (!facility.latitude || !facility.longitude) return;
                        
                        const index = facility.index || idx + 1;
                        
                        // Main marker
                        const marker = L.marker(
                            [facility.latitude, facility.longitude],
                            { icon: this.createFacilityIcon(index) }
                        ).addTo(this.map);
                        
                        // Format price
                        const priceText = facility.price 
                            ? `$${facility.price.toLocaleString()}`
                            : (facility.estimated_range || 'Contact for price');
                        
                        // Popup content
                        marker.bindPopup(`
                            <div class="popup-title">${facility.name}</div>
                            <div class="popup-address">${facility.address || ''}</div>
                            <div class="popup-details">
                                <span class="popup-distance">${facility.distance_miles ? facility.distance_miles.toFixed(1) + ' mi' : ''}</span>
                                <span class="popup-price">${priceText}</span>
                            </div>
                            ${facility.in_network ? '<div class="popup-network"><svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>In Network</div>' : ''}
                        `);
                        
                        marker.on('click', () => {
                            if (this.options.onFacilityClick) {
                                this.options.onFacilityClick(facility);
                            }
                        });
                        
                        this.markers.push(marker);
                        
                        // Add price label near marker (like Turquoise Health)
                        if (this.options.showPriceLabels && facility.price) {
                            const priceLabel = L.marker(
                                [facility.latitude, facility.longitude],
                                { 
                                    icon: this.createPriceLabel(facility.price),
                                    interactive: false,
                                    zIndexOffset: -100
                                }
                            ).addTo(this.map);
                            this.priceLabels.push(priceLabel);
                        }
                    });
                }
            }
            
            fitBounds() {
                const coords = [];
                
                if (this.mapData.user_location?.latitude && this.mapData.user_location?.longitude) {
                    coords.push([this.mapData.user_location.latitude, this.mapData.user_location.longitude]);
                }
                
                if (this.mapData.facilities?.length > 0) {
                    this.mapData.facilities.forEach(f => {
                        if (f.latitude && f.longitude) {
                            coords.push([f.latitude, f.longitude]);
                        }
                    });
                }
                
                if (coords.length > 1) {
                    const bounds = L.latLngBounds(coords);
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
            
            updateData(newMapData) {
                this.mapData = newMapData;
                this.addMarkers();
                this.fitBounds();
            }
            
            destroy() {
                if (this.map) {
                    this.map.remove();
                    this.map = null;
                }
            }
        }
        
        // Example usage with sample data
        const sampleMapData = {
            user_location: {
                latitude: 41.7658,
                longitude: -72.6734,
                zipcode: "06119"
            },
            facilities: [
                {
                    index: 1,
                    name: "Hartford Hospital",
                    latitude: 41.7542,
                    longitude: -72.6856,
                    address: "80 Seymour Street, Hartford, CT 06102",
                    price: 453,
                    distance_miles: 2.5,
                    in_network: true
                },
                {
                    index: 2,
                    name: "Bristol Hospital",
                    latitude: 41.6717,
                    longitude: -72.9462,
                    address: "41 Brewster Road, Bristol, CT 06010",
                    price: 1111,
                    distance_miles: 12.3,
                    in_network: true
                },
                {
                    index: 3,
                    name: "Charlotte Hungerford Hospital",
                    latitude: 41.8009,
                    longitude: -73.1218,
                    address: "540 Litchfield Street, Torrington, CT 06790",
                    price: 453,
                    distance_miles: 21.1,
                    in_network: false
                }
            ],
            center: {
                latitude: 41.7658,
                longitude: -72.6734
            },
            zoom: 10
        };
        
        // Initialize the map
        document.addEventListener('DOMContentLoaded', function() {
            const facilityMap = new FacilityMap('map', sampleMapData, {
                onFacilityClick: (facility) => {
                    console.log('Facility clicked:', facility);
                },
                showPriceLabels: true
            });
            
            // Expose for external use
            window.facilityMap = facilityMap;
        });
    </script>
</body>
</html>
